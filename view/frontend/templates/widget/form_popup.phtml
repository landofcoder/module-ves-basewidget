<?php
$title = $this->getData('title');
$form_widget_type = $this->getData('form_type');
$class = $this->getData('addition_class');
$expire = (int)$this->getData('expire');
$id = rand().time();
$cookie_name = 'widget-popup-'.$form_widget_type.$id;
$delay = (int)$this->getData('delay');
//Convert from seconds to milliseconds
$delay = $delay*1000;
$width = $this->getData('popup_width');
$height = $this->getData('popup_height');
$opacity = $this->getData('opacity');
$open_button_text = $this->getConfig('open_button_text', '');
$button_class = $this->getConfig('button_class', '');
$open_popup_first = $this->getConfig('open_popup_first', 1);
$show_disable_option = $this->getConfig('show_disable_option', 1);
$responsive_popup = $this->getConfig('responsive_popup', 0);
?>

<?php if(isset($html) && $html!= ''){ ?>
<?php if($open_button_text): ?>
	<a href="javascript:void(0);" onclick="return showPopup<?= $id ?>();" class="<?= $button_class; ?>"><?= $open_button_text; ?></a>
<?php endif; ?>
<div class="ves-widget widget-popup" id="widget-popup-<?= $form_widget_type.$id; ?>" style="display:none">
	<?= $html; ?>
	<?php if($show_disable_option): ?>
	<div class="clear">
		<div class="action_button">
	        <input type="checkbox" class="hide-popup-action" data-cookiename="<?= $cookie_name; ?>" name="action" id="action-position-<?= $form_widget_type.$id; ?>" value="hide">
	        <label class="checkbox-inline" for="action-position-<?= $form_widget_type.$id; ?>"><?= __("Not receive this message again"); ?></label>
	    </div>
	</div>
	<?php endif ; ?>
</div>
<script type="text/javascript">
function showPopup<?= $id ?>(){
	if(jQuery.cookie("<?= $cookie_name; ?>") == 'null' || jQuery.cookie("<?= $cookie_name; ?>") != "true"){
		var cboxOptions = {
				width: "<?= $width ?>",
			  	maxWidth: '960px',
			  	maxHeight: '960px',
			  	initialWidth: 300,
			  	initialHeight: 100
			}

			if(window.innerWidth > 780){
				cboxOptions.initialWidth = 600;
				cboxOptions.initialHeight = 450;
			}

			jQuery.colorbox({
				inline:true,
				href:'#widget-popup-<?= $form_widget_type.$id; ?>',
				<?php if($responsive_popup): ?>
				maxWidth: '960px',
			  	maxHeight: '960px',
			  	initialWidth: cboxOptions.initialWidth,
			  	initialHeight: cboxOptions.initialHeight,
				<?php endif; ?>
				width: "<?= $width ?>",
				/*height: "<?= $height ?>",*/
				opacity: <?= $opacity?$opacity:0.6; ?>,
				<?php if($title != ''){ ?>
					title:"<?= $title ?>",
				<?php } ?>
				onLoad:function(){

						<?php if($expire && $expire>0){ ?>
							// expires after number second
							var date = new Date();
							var second_number = <?= $expire  ?>;
							date.setTime(date.getTime() + (second_number * 1000));
							jQuery.cookie("<?= $cookie_name; ?>", "true", { expires: date });
							<?php } ?>

							jQuery('#widget-popup-<?= $form_widget_type.$id; ?>').show();
							<?php if($class != ''){ ?>
								jQuery("#colorbox").addClass("<?= $class; ?>");
								<?php } ?>
							},
				onClosed:function(){
								jQuery('#widget-popup-<?= $form_widget_type.$id; ?>').hide();
								<?php if($class != ''){ ?>
								jQuery("#colorbox").removeClass("<?= $class; ?>");
								<?php } ?>
								}
			});
			if(jQuery(".hide-popup-action").length > 0) {
				jQuery(".hide-popup-action").on('change', function() {
					var cookie_name = jQuery(this).data("cookiename");
					if(cookie_name && ("hide" == jQuery(this).val())) {
						jQuery.cookie(cookie_name, "true");
					}
				});
			}
			<?php if($responsive_popup): ?>
			jQuery(window).resize(function(){
			    jQuery.colorbox.resize({
			      width: window.innerWidth > parseInt(cboxOptions.maxWidth) ? cboxOptions.maxWidth : cboxOptions.width
			    });
			});
			<?php endif; ?>
	}

}
require(['jquery'],function($){
            $(document).ready(function(){
            	require([
						'jquery',
						'jquery/jquery.cookie'
						<?php if($this->helper("Ves\All\Helper\Data")->getConfig("enable_colorbox")): ?>
					    ,"Ves_All/lib/colorbox/jquery.colorbox.min"
					    <?php endif; ?>
						],function($){

							<?php if($expire <= 0)://Remove cookie when expire = 0 ?>
							$.removeCookie("<?= $cookie_name; ?>");
							<?php endif; ?>

							if($.cookie("<?= $cookie_name; ?>") == 'null' || $.cookie("<?= $cookie_name; ?>") != "true"){
									<?php if($open_popup_first): //Open popup on first load?>
										<?php if($delay && $delay>0): ?>
											setTimeout(showPopup<?= $id ?>,<?= $delay ?>);
										<?php else: ?>
											showPopup<?= $id ?>();
										<?php endif; ?>
									<?php endif; ?>

							}
					});
           });
        });

</script>
<?php } ?>
